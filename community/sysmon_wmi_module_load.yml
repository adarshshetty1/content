id: 69f57c452126478bb516cd468bfe9c4c
name: WMI Modules Loaded
path: /Advanced Threat Detection/Windows Process Monitoring
description: Detects non wmiprvse loading WMI modules
type: standard
author: community
blocks:
- type: text
  code: "|Author|References|\n                 |------|--------|\n               \
    \  |Roberto Rodriguez @Cyb3rWard0g|https://github.com/Cyb3rWard0g/ThreatHunter-Playbook/tree/master/playbooks/windows/02_execution/T1047_windows_management_instrumentation/wmi_wmi_module_load.md|"
- type: sql
  query: SELECT * FROM SYSMON-IMAGE-LOAD WHERE (($ImageLoaded LIKE "%\\wmiclnt.dll"
    OR $ImageLoaded LIKE "%\\WmiApRpl.dll" OR $ImageLoaded LIKE "%\\wmiprov.dll" OR
    $ImageLoaded LIKE "%\\wmiutils.dll" OR $ImageLoaded LIKE "%\\wbemcomn.dll" OR
    $ImageLoaded LIKE "%\\wbemprox.dll" OR $ImageLoaded LIKE "%\\WMINet\_Utils.dll"
    OR $ImageLoaded LIKE "%\\wbemsvc.dll" OR $ImageLoaded LIKE "%\\fastprox.dll")
    AND NOT (($Image LIKE "%\\WmiPrvSe.exe" OR $Image LIKE "%\\WmiAPsrv.exe" OR $Image
    LIKE "%\\svchost.exe" OR $Image LIKE "%\\DeviceCensus.exe" OR $Image LIKE "%\\CompatTelRunner.exe"
    OR $Image LIKE "%\\sdiagnhost.exe" OR $Image LIKE "%\\SIHClient.exe" OR $Image
    LIKE "%\\ngentask.exe" OR $Image LIKE "%\\windows\\system32\\taskhostw.exe" OR
    $Image LIKE "%\\windows\\system32\\MoUsoCoreWorker.exe")))
- type: signal
  DetectionName: WMI Modules Loaded
  DetectionTactic: Execution
  DetectionTechnique: Windows Management Instrumentation
  TargetHost: $System
  DetectionScore: 5
  DetectionConfidence: Low

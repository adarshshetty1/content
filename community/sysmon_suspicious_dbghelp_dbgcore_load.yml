id: ff0caf2c74484c328d027fb6c9439a52
name: Load of dbghelp/dbgcore DLL from Suspicious Process
path: /Advanced Threat Detection/Windows Process Monitoring
description: Detects the load of dbghelp/dbgcore DLL (used to make memory dumps) by
  suspicious processes. Tools like ProcessHacker and some attacker tradecract use
  MiniDumpWriteDump API found in dbghelp.dll or dbgcore.dll. As an example, SilentTrynity
  C2 Framework has a module that leverages this API to dump the contents of Lsass.exe
  and transfer it over the network back to the attacker's machine.
type: standard
author: community
blocks:
- type: text
  code: "|Author|References|\n                 |------|--------|\n               \
    \  |Perez Diego (@darkquassar), oscd.community, Ecco|https://docs.microsoft.com/en-us/windows/win32/api/minidumpapiset/nf-minidumpapiset-minidumpwritedump<br>https://www.pinvoke.net/default.aspx/dbghelp/MiniDumpWriteDump.html<br>https://medium.com/@fsx30/bypass-edrs-memory-protection-introduction-to-hooking-2efb21acffd6|"
- type: sql
  query: SELECT * FROM SYSMON-IMAGE-LOAD WHERE (((($ImageLoaded LIKE "%\\dbghelp.dll"
    OR $ImageLoaded LIKE "%\\dbgcore.dll") AND ($Image LIKE "%\\msbuild.exe" OR $Image
    LIKE "%\\cmd.exe" OR $Image LIKE "%\\svchost.exe" OR $Image LIKE "%\\rundll32.exe"
    OR $Image LIKE "%\\powershell.exe" OR $Image LIKE "%\\word.exe" OR $Image LIKE
    "%\\excel.exe" OR $Image LIKE "%\\powerpnt.exe" OR $Image LIKE "%\\outlook.exe"
    OR $Image LIKE "%\\monitoringhost.exe" OR $Image LIKE "%\\wmic.exe" OR $Image
    LIKE "%\\bash.exe" OR $Image LIKE "%\\wscript.exe" OR $Image LIKE "%\\cscript.exe"
    OR $Image LIKE "%\\mshta.exe" OR $Image LIKE "%\\regsvr32.exe" OR $Image LIKE
    "%\\schtasks.exe" OR $Image LIKE "%\\dnx.exe" OR $Image LIKE "%\\regsvcs.exe"
    OR $Image LIKE "%\\sc.exe" OR $Image LIKE "%\\scriptrunner.exe")) AND NOT ($Image
    LIKE "%Visual Studio%")) OR ((($ImageLoaded LIKE "%\\dbghelp.dll" OR $ImageLoaded
    LIKE "%\\dbgcore.dll") AND $Signed = "FALSE") AND NOT ($Image LIKE "%Visual Studio%")))
- type: signal
  DetectionName: Load of dbghelp/dbgcore DLL from Suspicious Process
  DetectionTactic: Credential Access
  DetectionTechnique: OS Credential Dumping
  TargetHost: $System
  DetectionScore: 5
  DetectionConfidence: Low
